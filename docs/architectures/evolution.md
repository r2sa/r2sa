# 架构演化
单体架构 -> 分层架构(水平、垂直(SOA)) -> 微服务

## 单体架构
### 优点
- simple to dev
- simple to test
- simple to deploy
- simple to scale

### 应用场景
- 业务场景简单、功能不复杂、研发人员较少
	- O2O
- 创业公司初期
- 性能要求极其苛刻 (平均响应时间)
	- 股票高频交易

### 缺点
- 系统耦合性高
- 技术选项单一
- 开发效率越来越低下

### 如何破局
- 数据库存储量大破局思路
	- 拆分
		- 垂直拆分(分库)
		- 水平拆分(分表)
- 架构同理
	- 垂直方向拆分(业务维度)
	- 水平方向拆分(功能维度) 



## 水平分层架构
### 同步水平分层架构全貌
- DNS域名解析
- 静态资源获取
- 动态接口数据获取

![同步水平分层架构全貌](https://s2.ax1x.com/2019/07/15/ZTzgP0.png)

### 架构设计
- 水平方向物理分成多个独立进程
	- 网关层
	- 异步消息队列层
	- 业务逻辑层
	- 数据访问层
	- 数据存储层
- 每层逻辑解耦
- 任意两层之间可增加MQ变为异步架构

#### 网关层
- 功能
	- 请求鉴权
	- 数据完整性检查
	- 协议转换
	- 路由转发
	- 服务治理
- 开源网关组件
|对比维度|Zuul(推荐)|Spring Clound Geteway|Nginx|Kong|Tyk|Node.js|
|---|---|---|---|---|---|---|
|编程语言|Java|Java|C|C + lua|Go|js|
|成熟度|高|低|高|高|高|高|
|使用成本|低|较低|高|较低|较低|较低|
|IO模型|BIO|Netty(NIO)|epoll|epoll|AIO|AIO|
|技术生态|Netflix|Spring Cloud|Nginx社区|OpenRestry|Go社区|Node.js社区|
|适用场景|网关|网关|负载均衡|网关|网关|网关|

#### 业务逻辑层
- 功能
	- 业务逻辑判断

#### 数据访问层
- 功能
	- CRUD
	- ORM
	- Sharding (分库分表) 
		- newsql 替代方案
	- 屏蔽底层数据存储差异性

#### 异步架构
- 手段
	- 任意两层之间可增加MQ变为异步架构
		- 通常放在网关层与业务逻辑层之间
			- @todo why?
- 目的
	- 来提升吞吐量
	- @todo MQ为什么快?
		- 写DB为随机写，写MQ为顺序写，所以MQ快
- 使用场景
	- 并发高、数据一致性要求弱的写请求
		- eg:发微博

#### ? PHP 如何实现
- 水平分层强调的是物理上的分层，与MVC并不同
- 水平物理分层，涉及到网络操作、进程控制等，php不擅长，所以php基本不会做水平分层架构
- @todo 考虑用swoole支持

### 缺点
- 每层粒度过粗



## SOA 面向服务架构
SOA架构是单体架构垂直拆分的结果

### 架构设计
- 多个独立服务
- 通过 ESB 交互
	- ESB: 企业服务总线

### 缺点
- 业务垂直方向拆分
	- 每个服务还是单体
- 对 ESB 严重依赖



## 微服务架构
### 本质
- 两个维度拆分
	- 水平
	- 垂直
- 业务架构
- 组织架构

### 使用场景
- 需求层面
	- 快速迭代, 持续交付
	- 降本提效
- 性能层面
	- 使用微服务吞吐量变高
	- 使用微服务平均响应延时变高
- 数据一致性层面
	- 最终一致性

### 转转微服务架构
![转转微服务架构1.0](architectures/zzmicro1.jpg)

### Service Mesh
- 是什么
	- 服务网格是个*基础设施层*，用于处理服务间通信
	- 云原生应用有着复杂的服务拓扑，服务网格复杂在这些拓扑中*实现请求的可靠传递*
	- 服务网格通常实现为一组*轻量级网络代理*应用程序部署在一起，*对应用程序透明*
- @todo

## 参考资料
- [知乎:什么是微服务架构](https://www.zhihu.com/question/65502802)
- [转转公司微服务架构演进之路](https://www.slidestalk.com/u3502/Evolution_of_Microsoft_Service_Architecture_for_Transfer_Compani)